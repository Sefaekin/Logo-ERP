ALTER VIEW [dbo].[NR_007_MALZEME_FIYAT_BARKOD]AS
SELECT    DISTINCT
I.CODE AS [MALZEME KODU], I.NAME AS [MALZEME AÇIKLAMASI],VRY.CODE AS VARYANT_KODU, I.NAME4 AS [MALZEME AÇIKLAMASI3],
I.PRODUCERCODE AS [ÜRETİCİ KODU], 
I.STGRPCODE AS [GRUP KODU], I.SPECODE AS [ÖZEL KODU], 

(SELECT SUM(ONHAND)  FROM LV_007_01_VRNTINVTOT MVT WHERE MVT.STOCKREF=I.LOGICALREF AND MVT.VARIANTREF=VRY.LOGICALREF AND MVT.INVENNO='-1')AS [MALZEME VARYANT STOK],--      AND CANCELLED = 0 AND TRCODE >= 7 AND GRPCODE = 2)
(SELECT SUM(ONHAND) FROM LV_007_01_STINVTOT MT WHERE MT.STOCKREF=I.LOGICALREF AND MT.INVENNO='-1' )  AS [MALZEME STOK],

(Select TOP 1 D.PRICE From LG_007_PRCLIST D Where D.CARDREF = I.LOGICALREF And D.PTYPE = 1 And D.ACTIVE = 0  Order By D.BEGDATE Desc) As [ALIŞ FİYAT], 
(Select TOP 1 D.PRICE From LG_007_PRCLIST D Where D.CARDREF = I.LOGICALREF And D.PTYPE = 2 And D.ACTIVE = 0  Order By D.BEGDATE Desc) As [SATIŞ FİYAT], 
(SELECT TOP 1 BARCODE FROM LG_007_UNITBARCODE B WHERE B.ITEMREF=I.LOGICALREF ) [MALZEME BARKODU],
(SELECT TOP 1 BARCODE FROM LG_007_UNITBARCODE B WHERE B.ITEMREF=I.LOGICALREF AND B.VARIANTREF=VRY.LOGICALREF) [VARYANT BARKODU],

CASE G.INFOREF WHEN  I.LOGICALREF THEN 'VAR' ELSE 'YOK' END AS [ÜRÜN GÖRSELİ]

FROM dbo.LG_007_ITEMS AS I 
LEFT OUTER JOIN LG_007_VARIANT VRY ON I.LOGICALREF=VRY.ITEMREF
LEFT OUTER JOIN LG_007_FIRMDOC AS G ON G.INFOREF =I.LOGICALREF AND G.INFOTYP='20'


WHERE     (I.ACTIVE = 0)  --AND I.CODE IN ('PB-42408','PB-42411')--,'PB-32010','PB-25020')
GROUP BY I.CODE,I.NAME,VRY.CODE,I.NAME4,I.PRODUCERCODE,I.STGRPCODE,I.SPECODE,G.INFOREF,I.LOGICALREF,VRY.LOGICALREF

--SELECT ONHAND,INVENNO,* FROM LV_007_01_STINVTOT WHERE STOCKREF='219627' --AND INVENNO=-1
--SELECT VARIANTREF,ONHAND,INVENNO,* FROM LV_007_01_STINVTOT_V1 WHERE STOCKREF='219627' --AND INVENNO=-1
--SELECT VARIANTREF,ONHAND,INVENNO,* FROM LV_007_01_STINVTOT_V1 WHERE VARIANTREF='245'
--SELECT ABVATSTATUS,* FROM LG_007_01_STLINE WHERE VARIANTREF='245'

--SELECT ONHAND,INVENNO,* FROM LV_007_01_VRNTINVTOT WHERE STOCKREF='219627' AND INVENNO='-1'