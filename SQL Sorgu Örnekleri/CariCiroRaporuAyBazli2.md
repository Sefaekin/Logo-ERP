

SELECT C.CODE AS [CARİ KODU],C.DEFINITION_ AS [CARİ ÜNVANI],S.CODE AS [SATICI],MONTH(F.DATE_) AS AY,C.SPECODE [CARİ ÖZEL KODU],F.FICHENO,
COUNT(F.LOGICALREF) AS [FATURA ADEDİ],
SUM(CASE WHEN F.TRCODE=3 THEN (ST.LINENET)*-1 ELSE (ST.LINENET) END) AS [BRÜT TUTAR],
SUM(CASE WHEN F.TRCODE=3 THEN (ST.DISTDISC)*-1 ELSE (ST.DISTDISC) END) AS [İNDİRİM TUTARI],
SUM(CASE WHEN F.TRCODE=3 THEN (ST.VATMATRAH+ST.DIFFPRICE)*-1 ELSE (ST.VATMATRAH+ST.DIFFPRICE) END) AS [NET TUTAR], --SUM(F.TOTALDISCOUNTED) AS [KDV MATRAHI],
SUM(CASE WHEN F.TRCODE=3 THEN (ST.VATAMNT)*-1 ELSE ST.VATAMNT END) AS [KDV TUTARI],
SUM(CASE WHEN F.TRCODE=3 THEN (ST.VATAMNT+ST.VATMATRAH+ST.DIFFPRICE)*-1 ELSE (ST.VATAMNT+ST.VATMATRAH+ST.DIFFPRICE) END) AS [KDV DAHİL TOPLAM]  

--SUM(F.NETTOTAL)-SUM(F.TOTALVAT

FROM LG_001_CLCARD C
LEFT JOIN LG_001_01_INVOICE F ON F.CLIENTREF=C.LOGICALREF
LEFT JOIN LG_001_01_STLINE ST ON F.LOGICALREF=ST.INVOICEREF
LEFT JOIN LG_SLSMAN S ON F.SALESMANREF=S.LOGICALREF
WHERE F.CANCELLED=0 AND ST.LINETYPE IN (0,4) AND ST.BILLED=1  AND F.TRCODE IN (3,8,9)--AND C.CODE='120.K.0052'
GROUP BY C.CODE,C.DEFINITION_,S.CODE,C.SPECODE,MONTH(F.DATE_),F.FICHENO ORDER BY C.CODE


