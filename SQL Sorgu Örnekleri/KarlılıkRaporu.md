--ALTER view [dbo].[NR_023_SATIS_FATURALARI_RAPORU] AS

SELECT
INV.DATE_ FATURA_TARİHİ,
INV.FICHENO FATURA_NUMARASI,
SLS.DEFINITION_ SATIŞ_ELEMANI,
CK.CODE CARİ_KODU,
CK.DEFINITION_ CARİ_ÜNVAN,
ITM.CODE MALZEME_KODU,
ITM.NAME MALZEME_AÇIKLAMASI,
STL.AMOUNT MİKTAR,
STL.PRICE BİRİM_FİYAT,
STL.LINENET SATIR_TOPLAMI,
SSF.[BİRİM FİYAT] SON_SATINALMA_FIYATI,
SON_SATIS_FIYATI=(SELECT TOP 1 PRICE FROM LG_023_01_STLINE F WHERE F.CLIENTREF=CK.LOGICALREF AND F.STOCKREF=ITM.LOGICALREF ORDER BY DATE_ DESC), 
TANIMLI_SATINALMA_FIYATI=(SELECT TOP 1 PRICE FROM LG_023_PRCLIST PRC WHERE PRC.CARDREF=ITM.LOGICALREF ORDER BY LOGICALREF DESC), 
STL.LINENET-(STL.AMOUNT*SSF.[BİRİM FİYAT]) AS [KARLILIK(SON SATINALMA)],
STL.LINENET-(STL.AMOUNT*(SELECT TOP 1 PRICE FROM LG_023_PRCLIST PRC WHERE PRC.CARDREF=ITM.LOGICALREF ORDER BY LOGICALREF DESC)) AS [KARLILIK(TANIMLI SATINALMA)]
FROM
LG_023_CLCARD CK
LEFT JOIN LG_023_01_INVOICE INV ON CK.LOGICALREF=INV.CLIENTREF
LEFT JOIN LG_023_01_STFICHE STF ON INV.LOGICALREF=STF.INVOICEREF
LEFT JOIN
LG_023_01_STLINE STL ON
STF.LOGICALREF=STL.STFICHEREF
LEFT JOIN
LG_023_ITEMS ITM ON
STL.STOCKREF=ITM.LOGICALREF
LEFT JOIN
LG_SLSMAN SLS ON
INV.SALESMANREF=SLS.LOGICALREF
LEFT JOIN
NR_023_SON_SATINALMA_FIYATLARI SSF ON
ITM.CODE=SSF.MALZEME_KODU
WHERE 
INV.DATE_>='2021' AND INV.TRCODE='8' AND INV.CANCELLED='0'

GO


