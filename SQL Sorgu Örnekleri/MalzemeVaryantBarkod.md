--ALTER VIEW [dbo].[NR_007_MALZEME_FIYAT_BARKOD]AS
SELECT    DISTINCT
I.CODE AS [MALZEME KODU], I.NAME AS [MALZEME AÇIKLAMASI],VRY.CODE AS VARYANT_KODU, I.NAME4 AS [MALZEME AÇIKLAMASI3],
B.BARCODE AS BARKOD, F.PRICE AS FİYAT, I.PRODUCERCODE AS [ÜRETİCİ KODU], 
I.STGRPCODE AS [GRUP KODU], I.SPECODE AS [ÖZEL KODU], 

--SUM(MT.ONHAND)[MALZEME STOK],
--SUM(MVT.ONHAND)[MALZEME VARYANT STOK],

(SELECT SUM(ONHAND)  FROM LV_999_01_STINVTOT_V1 MVT WHERE MVT.STOCKREF=I.LOGICALREF AND MVT.VARIANTREF=VRY.LOGICALREF)AS [MALZEME VARYANT STOK],--      AND CANCELLED = 0 AND TRCODE >= 7 AND GRPCODE = 2)
(SELECT SUM(ONHAND) FROM LV_999_01_STINVTOT MT WHERE MT.STOCKREF=I.LOGICALREF AND MT.INVENNO='-1' )  AS [MALZEME STOK],

CASE F.PTYPE WHEN 1 THEN 'ALIŞ FİYATI' WHEN 2 THEN 'SATIŞ FİYATI' ELSE 'FİYATSIZ' END AS [FİYAT BİLGİSİ],
CASE G.INFOREF WHEN  I.LOGICALREF THEN 'VAR' ELSE 'YOK' END AS [ÜRÜN GÖRSELİ]

FROM dbo.LG_999_ITEMS AS I 
LEFT OUTER JOIN LG_999_VARIANT VRY ON I.LOGICALREF=VRY.ITEMREF
LEFT OUTER JOIN dbo.LG_999_PRCLIST AS F ON F.CARDREF = I.LOGICALREF AND VRY.CODE=F.VARIANTCODE
LEFT OUTER JOIN dbo.LG_999_UNITBARCODE AS B ON I.LOGICALREF = B.ITEMREF 
LEFT OUTER JOIN LG_999_FIRMDOC AS G ON G.INFOREF =I.LOGICALREF AND G.INFOTYP='20'
--LEFT OUTER JOIN LV_999_01_STINVTOT_V1 AS MVT ON MVT.STOCKREF=I.LOGICALREF AND MVT.VARIANTREF=VRY.LOGICALREF
--LEFT OUTER JOIN LV_999_01_STINVTOT AS MT ON MT.STOCKREF=I.LOGICALREF

WHERE     (I.ACTIVE = 0) --AND I.CODE IN('VARYANTLI','MALZEMEKODU') --AND F.ACTIVE=0 
GROUP BY I.CODE,I.NAME,VRY.CODE,I.NAME4,B.BARCODE,F.PRICE,I.PRODUCERCODE,I.STGRPCODE,I.SPECODE,F.PTYPE,G.INFOREF,I.LOGICALREF,VRY.LOGICALREF


--SELECT * FROM LG_999_ITEMS WHERE CODE='MALZEMEKODU'
--SELECT VARIANTREF,ONHAND,* FROM LV_999_01_STINVTOT_V1 WHERE STOCKREF IN (20,2)
--SELECT VARIANTCODE,* FROM LG_999_PRCLIST WHERE CARDREF='20'